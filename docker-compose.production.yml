services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: bea
      POSTGRES_PASSWORD: bea_pass
      POSTGRES_DB: bea
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: ["server", "/data", "--console-address", ":9001"]
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data

  lightrag:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      CHROMA_PERSIST_DIR: /data/chroma
      EMBEDDING_BACKEND: simple
      EMBEDDING_DIM: "128"
    ports:
      - "8081:8081"
    command: ["uvicorn", "app.lightrag_service:app", "--host", "0.0.0.0", "--port", "8081"]
    volumes:
      - chroma_data:/data/chroma

  api:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      BEA_STORE_BACKEND: postgres
      BEA_QUEUE_BACKEND: redis
      BEA_REQUIRE_TRUESTACK: "true"
      TRACE_ID_STRICT_REQUIRED: "true"
      POSTGRES_DSN: postgresql://bea:bea_pass@postgres:5432/bea
      REDIS_DSN: redis://redis:6379/0
      POSTGRES_APPLY_RLS: "true"
      BEA_OBJECT_STORAGE_BACKEND: s3
      OBJECT_STORAGE_ENDPOINT: http://minio:9000
      OBJECT_STORAGE_PUBLIC_ENDPOINT: http://localhost:9000
      OBJECT_STORAGE_BUCKET: bea
      OBJECT_STORAGE_REGION: us-east-1
      OBJECT_STORAGE_ACCESS_KEY: minioadmin
      OBJECT_STORAGE_SECRET_KEY: minioadmin
      OBJECT_STORAGE_FORCE_PATH_STYLE: "true"
      OBJECT_STORAGE_WORM_MODE: GOVERNANCE
      WORM_RETENTION_DAYS: "30"
      JWT_ISSUER: http://jwks:8000/
      JWT_AUDIENCE: bea-api
      JWT_JWKS_URL: http://jwks:8000/jwks.json
      JWT_ALG: RS256
      LIGHTRAG_DSN: http://lightrag:8081
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    depends_on:
      - postgres
      - redis
      - minio
      - lightrag
      - jwks
    ports:
      - "8010:8010"

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      BEA_STORE_BACKEND: postgres
      BEA_QUEUE_BACKEND: redis
      BEA_REQUIRE_TRUESTACK: "true"
      POSTGRES_DSN: postgresql://bea:bea_pass@postgres:5432/bea
      REDIS_DSN: redis://redis:6379/0
      POSTGRES_APPLY_RLS: "true"
      BEA_OBJECT_STORAGE_BACKEND: s3
      OBJECT_STORAGE_ENDPOINT: http://minio:9000
      OBJECT_STORAGE_PUBLIC_ENDPOINT: http://localhost:9000
      OBJECT_STORAGE_BUCKET: bea
      OBJECT_STORAGE_REGION: us-east-1
      OBJECT_STORAGE_ACCESS_KEY: minioadmin
      OBJECT_STORAGE_SECRET_KEY: minioadmin
      OBJECT_STORAGE_FORCE_PATH_STYLE: "true"
      OBJECT_STORAGE_WORM_MODE: GOVERNANCE
      WORM_RETENTION_DAYS: "30"
      LIGHTRAG_DSN: http://lightrag:8081
    depends_on:
      - postgres
      - redis
      - minio
      - lightrag
    command: ["python", "scripts/run_worker.py"]

  frontend:
    image: node:20-alpine
    working_dir: /app/frontend
    volumes:
      - ./frontend:/app/frontend
    environment:
      VITE_API_BASE_URL: http://localhost:8010
    command: ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0 --port 5173"]
    ports:
      - "5173:5173"

  jwks:
    image: nginx:alpine
    volumes:
      - ./secrets/jwks.json:/usr/share/nginx/html/jwks.json:ro
    ports:
      - "8000:80"
    command: ["nginx", "-g", "daemon off;"]

  otel-collector:
    image: otel/opentelemetry-collector:0.100.0
    volumes:
      - ./deploy/otel-collector.yml:/etc/otelcol/config.yaml:ro
    ports:
      - "4317:4317"

  prometheus:
    image: prom/prometheus:v2.54.0
    volumes:
      - ./deploy/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:11.2.0
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  pg_data:
  redis_data:
  minio_data:
  chroma_data:
  grafana_data:
