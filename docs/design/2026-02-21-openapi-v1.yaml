openapi: 3.1.0
info:
  title: Bid Evaluation Assistant API
  version: v2026.02.21-r3
  description: |
    Gate C OpenAPI contract subset for async job submission, parse/resume/cancel,
    job status query, DLQ operations, citation source lookup, and retrieval query/preview.
servers:
  - url: /api/v1
security:
  - BearerAuth: []

paths:
  /documents/upload:
    post:
      operationId: uploadDocument
      summary: Upload a document and enqueue parse/index job
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [project_id, supplier_id, doc_type, file]
              properties:
                project_id:
                  type: string
                supplier_id:
                  type: string
                doc_type:
                  type: string
                  enum: [tender, bid, attachment]
                file:
                  type: string
                  format: binary
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadAcceptedResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_failed:
                  value:
                    success: false
                    error:
                      code: REQ_VALIDATION_FAILED
                      message: invalid payload
                      retryable: false
                      class: validation
                    meta:
                      trace_id: trace_xxx
                      request_id: req_xxx
        '403':
          description: Tenant scope violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                tenant_scope_violation:
                  value:
                    success: false
                    error:
                      code: TENANT_SCOPE_VIOLATION
                      message: tenant mismatch
                      retryable: false
                      class: security_sensitive
                    meta:
                      trace_id: trace_xxx
                      request_id: req_xxx
        '409':
          description: Idempotency conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                idempotency_conflict:
                  value:
                    success: false
                    error:
                      code: IDEMPOTENCY_CONFLICT
                      message: same key with different payload
                      retryable: false
                      class: validation
                    meta:
                      trace_id: trace_xxx
                      request_id: req_xxx

  /evaluations:
    post:
      operationId: createEvaluation
      summary: Create an evaluation and enqueue async workflow job
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEvaluationRequest'
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvaluationAcceptedResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tenant scope violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Idempotency conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /retrieval/query:
    post:
      operationId: retrievalQuery
      summary: Query retrieval candidates with mode selection and metadata filtering
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetrievalQueryRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetrievalQueryResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tenant scope violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /retrieval/preview:
    post:
      operationId: retrievalPreview
      summary: Preview retrieval evidence without scoring flow
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetrievalQueryRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetrievalPreviewResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tenant scope violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /documents/{document_id}/parse:
    post:
      operationId: parseDocument
      summary: Enqueue parse/index job for an uploaded document
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParseAcceptedResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tenant scope violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /evaluations/{evaluation_id}/resume:
    post:
      operationId: resumeEvaluation
      summary: Resume interrupted HITL workflow
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/EvaluationId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResumeRequest'
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResumeAcceptedResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Invalid resume token or workflow state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_resume_token:
                  value:
                    success: false
                    error:
                      code: WF_INTERRUPT_RESUME_INVALID
                      message: resume token expired or mismatched
                      retryable: false
                      class: business_rule
                    meta:
                      trace_id: trace_xxx
                      request_id: req_xxx

  /jobs/{job_id}:
    get:
      operationId: getJobStatus
      summary: Query async job status
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatusResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tenant scope violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /jobs:
    get:
      operationId: listJobs
      summary: List jobs with optional filters and cursor pagination
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          required: false
          schema:
            type: string
        - name: type
          in: query
          required: false
          schema:
            type: string
        - name: cursor
          in: query
          required: false
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobListResponse'
  /jobs/{job_id}/cancel:
    post:
      operationId: cancelJob
      summary: Cancel a non-terminal async job
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/JobId'
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelAcceptedResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tenant scope violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Cancel conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /dlq/items:
    get:
      operationId: listDlqItems
      summary: List DLQ items
      security:
        - BearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DlqListResponse'

  /dlq/items/{item_id}/requeue:
    post:
      operationId: requeueDlqItem
      summary: Requeue an open DLQ item
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ItemId'
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DlqRequeueAcceptedResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: DLQ item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Requeue conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /dlq/items/{item_id}/discard:
    post:
      operationId: discardDlqItem
      summary: Discard a DLQ item with approval fields
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ItemId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DlqDiscardRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DlqDiscardResponse'
        '400':
          description: Missing approval fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: DLQ item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /citations/{chunk_id}/source:
    get:
      operationId: getCitationSource
      summary: Resolve citation to source content and viewport hint
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ChunkId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CitationSourceResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      schema:
        type: string
        minLength: 8
      description: Required for all write endpoints
    JobId:
      name: job_id
      in: path
      required: true
      schema:
        type: string
    EvaluationId:
      name: evaluation_id
      in: path
      required: true
      schema:
        type: string
    ChunkId:
      name: chunk_id
      in: path
      required: true
      schema:
        type: string
    DocumentId:
      name: document_id
      in: path
      required: true
      schema:
        type: string
    ItemId:
      name: item_id
      in: path
      required: true
      schema:
        type: string

  schemas:
    Meta:
      type: object
      required: [trace_id]
      properties:
        trace_id:
          type: string
        request_id:
          type: string

    ErrorObject:
      type: object
      required: [code, message, retryable, class]
      properties:
        code:
          type: string
        message:
          type: string
        retryable:
          type: boolean
        class:
          type: string
          enum: [validation, business_rule, transient, permanent, security_sensitive]
        details:
          type: object
          additionalProperties: true
        retry_after_seconds:
          type: integer
          minimum: 1

    ErrorResponse:
      type: object
      required: [success, error, meta]
      properties:
        success:
          type: boolean
          const: false
        error:
          $ref: '#/components/schemas/ErrorObject'
        meta:
          $ref: '#/components/schemas/Meta'

    UploadAcceptedData:
      type: object
      required: [document_id, job_id, status, next]
      properties:
        document_id:
          type: string
        job_id:
          type: string
        status:
          type: string
          enum: [queued]
        next:
          type: string

    UploadAcceptedResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/UploadAcceptedData'
        meta:
          $ref: '#/components/schemas/Meta'

    CreateEvaluationRequest:
      type: object
      required: [project_id, supplier_id, rule_pack_version, evaluation_scope, query_options]
      properties:
        project_id:
          type: string
        supplier_id:
          type: string
        rule_pack_version:
          type: string
        evaluation_scope:
          type: object
          required: [include_doc_types, force_hitl]
          properties:
            include_doc_types:
              type: array
              items:
                type: string
                enum: [tender, bid, attachment]
            force_hitl:
              type: boolean
        query_options:
          type: object
          required: [mode_hint, top_k]
          properties:
            mode_hint:
              type: string
              enum: [local, global, hybrid, mix]
            top_k:
              type: integer
              minimum: 1
              maximum: 200

    EvaluationAcceptedData:
      type: object
      required: [evaluation_id, job_id, status]
      properties:
        evaluation_id:
          type: string
        job_id:
          type: string
        status:
          type: string
          enum: [queued]

    EvaluationAcceptedResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/EvaluationAcceptedData'
        meta:
          $ref: '#/components/schemas/Meta'

    ParseAcceptedData:
      type: object
      required: [document_id, job_id, status]
      properties:
        document_id:
          type: string
        job_id:
          type: string
        status:
          type: string
          enum: [queued]

    ParseAcceptedResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/ParseAcceptedData'
        meta:
          $ref: '#/components/schemas/Meta'

    ResumeRequest:
      type: object
      required: [resume_token, decision, comment]
      properties:
        resume_token:
          type: string
        decision:
          type: string
          enum: [approve, reject, edit_scores]
        comment:
          type: string
        edited_scores:
          type: array
          items:
            type: object
            additionalProperties: true

    ResumeAcceptedData:
      type: object
      required: [evaluation_id, job_id, status]
      properties:
        evaluation_id:
          type: string
        job_id:
          type: string
        status:
          type: string
          enum: [queued]

    ResumeAcceptedResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/ResumeAcceptedData'
        meta:
          $ref: '#/components/schemas/Meta'

    RetrievalQueryRequest:
      type: object
      required: [project_id, supplier_id, query, query_type]
      properties:
        project_id:
          type: string
        supplier_id:
          type: string
        query:
          type: string
          minLength: 1
        query_type:
          type: string
          enum: [fact, relation, comparison, summary, risk]
        high_risk:
          type: boolean
          default: false
        top_k:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
        enable_rerank:
          type: boolean
          default: true
        doc_scope:
          type: array
          items:
            type: string
            enum: [tender, bid, attachment]
        must_include_terms:
          type: array
          items:
            type: string
        must_exclude_terms:
          type: array
          items:
            type: string

    RetrievalItemMetadata:
      type: object
      required: [project_id, supplier_id, doc_type, page, bbox]
      properties:
        project_id:
          type: string
        supplier_id:
          type: string
        doc_type:
          type: string
          enum: [tender, bid, attachment]
        page:
          type: integer
          minimum: 1
        bbox:
          type: array
          minItems: 4
          maxItems: 4
          items:
            type: number

    RetrievalItem:
      type: object
      required: [chunk_id, score_raw, reason, metadata]
      properties:
        chunk_id:
          type: string
        score_raw:
          type: number
        score_rerank:
          oneOf:
            - type: 'null'
            - type: number
        reason:
          type: string
        metadata:
          $ref: '#/components/schemas/RetrievalItemMetadata'

    RetrievalQueryData:
      type: object
      required: [query, query_type, selected_mode, degraded, items, total]
      properties:
        query:
          type: string
        query_type:
          type: string
          enum: [fact, relation, comparison, summary, risk]
        selected_mode:
          type: string
          enum: [local, global, hybrid, mix]
        degraded:
          type: boolean
        items:
          type: array
          items:
            $ref: '#/components/schemas/RetrievalItem'
        total:
          type: integer
          minimum: 0

    RetrievalQueryResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/RetrievalQueryData'
        meta:
          $ref: '#/components/schemas/Meta'

    RetrievalPreviewItem:
      type: object
      required: [chunk_id, document_id, page, bbox, text]
      properties:
        chunk_id:
          type: string
        document_id:
          type: string
        page:
          type: integer
          minimum: 1
        bbox:
          type: array
          minItems: 4
          maxItems: 4
          items:
            type: number
        text:
          type: string

    RetrievalPreviewData:
      type: object
      required: [query, selected_mode, items, total]
      properties:
        query:
          type: string
        selected_mode:
          type: string
          enum: [local, global, hybrid, mix]
        items:
          type: array
          items:
            $ref: '#/components/schemas/RetrievalPreviewItem'
        total:
          type: integer
          minimum: 0

    RetrievalPreviewResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/RetrievalPreviewData'
        meta:
          $ref: '#/components/schemas/Meta'

    JobResource:
      type: object
      required: [type, id]
      properties:
        type:
          type: string
          enum: [document, evaluation, job]
        id:
          type: string

    JobStatusData:
      type: object
      required: [job_id, job_type, status, retry_count, trace_id, resource]
      properties:
        job_id:
          type: string
        job_type:
          type: string
          enum: [upload, parse, evaluation, resume, requeue]
        status:
          type: string
          enum:
            - queued
            - running
            - retrying
            - succeeded
            - failed
            - needs_manual_decision
            - dlq_pending
            - dlq_recorded
        progress_pct:
          type: integer
          minimum: 0
          maximum: 100
        retry_count:
          type: integer
          minimum: 0
        trace_id:
          type: string
        resource:
          $ref: '#/components/schemas/JobResource'
        last_error:
          oneOf:
            - type: 'null'
            - $ref: '#/components/schemas/ErrorObject'

    JobStatusResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/JobStatusData'
        meta:
          $ref: '#/components/schemas/Meta'

    JobListData:
      type: object
      required: [items, total]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/JobStatusData'
        total:
          type: integer
          minimum: 0
        next_cursor:
          oneOf:
            - type: 'null'
            - type: string

    JobListResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/JobListData'
        meta:
          $ref: '#/components/schemas/Meta'

    CancelAcceptedData:
      type: object
      required: [job_id, status, error_code]
      properties:
        job_id:
          type: string
        status:
          type: string
          enum: [failed]
        error_code:
          type: string
          enum: [JOB_CANCELLED]

    CancelAcceptedResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/CancelAcceptedData'
        meta:
          $ref: '#/components/schemas/Meta'

    CitationSourceData:
      type: object
      required: [chunk_id, document_id, page, bbox, text, context]
      properties:
        chunk_id:
          type: string
        document_id:
          type: string
        filename:
          type: string
        page:
          type: integer
          minimum: 1
        bbox:
          type: array
          minItems: 4
          maxItems: 4
          items:
            type: number
        text:
          type: string
        context:
          type: string
        viewport_hint:
          type: object
          required: [scale, unit]
          properties:
            scale:
              type: number
            unit:
              type: string
              enum: [pdf_point]

    CitationSourceResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/CitationSourceData'
        meta:
          $ref: '#/components/schemas/Meta'

    DlqItem:
      type: object
      required: [dlq_id, job_id, error_class, error_code, status]
      properties:
        dlq_id:
          type: string
        job_id:
          type: string
        error_class:
          type: string
        error_code:
          type: string
        status:
          type: string
          enum: [open, requeued, discarded]

    DlqListData:
      type: object
      required: [items, total]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/DlqItem'
        total:
          type: integer
          minimum: 0

    DlqListResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/DlqListData'
        meta:
          $ref: '#/components/schemas/Meta'

    DlqRequeueAcceptedData:
      type: object
      required: [dlq_id, job_id, status]
      properties:
        dlq_id:
          type: string
        job_id:
          type: string
        status:
          type: string
          enum: [queued]

    DlqRequeueAcceptedResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/DlqRequeueAcceptedData'
        meta:
          $ref: '#/components/schemas/Meta'

    DlqDiscardRequest:
      type: object
      required: [reason, reviewer_id]
      properties:
        reason:
          type: string
        reviewer_id:
          type: string

    DlqDiscardData:
      type: object
      required: [dlq_id, status]
      properties:
        dlq_id:
          type: string
        status:
          type: string
          enum: [discarded]

    DlqDiscardResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/DlqDiscardData'
        meta:
          $ref: '#/components/schemas/Meta'
