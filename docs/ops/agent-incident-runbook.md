# AI Agent 事故运行手册（Runbook）

> 版本：v2026.02.21-r3  
> 状态：Active  
> 适用范围：生产环境（API / Worker / Workflow / HITL / DLQ）

## 1. 目标

1. 在故障时提供统一止损、恢复、复盘流程。
2. 降低二次事故风险。
3. 保证处理过程有审计证据。

## 2. 事故分级

### P0（阻断级）

1. 多租户越权确认。
2. 终审结果大面积错误且对外输出。
3. 主链路不可用。

要求：5 分钟止损，15 分钟内应急会。

### P1（高优先级）

1. 评估/HITL/DLQ 持续异常。
2. 幻觉率或错引率显著超阈值。
3. 成本异常飙升影响业务。

要求：15 分钟止损，30 分钟给恢复路径。

### P2（中优先级）

1. 局部模块退化，存在替代路径。
2. 局部租户受影响。

要求：当日修复并复盘。

## 3. 首次响应（T+0 到 T+15）

1. 建立事故上下文：`incident_id, tenant_scope, trace_id/job_id, first_seen_at`。
2. 执行止损：
   - 暂停高风险写接口。
   - 切只读/低风险模式。
   - 必要时触发全局 Kill Switch。
3. 通知责任链：值班、技术、安全、业务。

## 4. 标准止损动作库

### 4.1 质量异常（幻觉/错引）

1. 提高 HITL 比例。
2. 回滚到稳定检索参数。
3. 限制复杂任务并发。

### 4.2 稳定性异常（队列/重试风暴）

1. 冻结低优先级任务入队。
2. 扩容 Worker 并设置租户并发上限。
3. 快速将重复失败任务路由到 DLQ。

### 4.3 安全异常（租户/权限）

1. 立即禁用相关接口。
2. 吊销可疑令牌。
3. 固化证据并启动安全事件流程。

## 5. 恢复流程（T+15 到关闭）

1. 根因定位：节点、工具、模型、配置、数据。
2. 选择恢复策略：参数回滚/版本回滚/补丁发布。
3. 预发复现与验证。
4. 分层恢复流量。
5. 验证关键指标恢复后关闭事故。

## 6. DLQ 专章

1. 统计受影响 `dlq_items` 数量与分布。
2. 分类：可重试/不可重试/需人工处理。
3. `requeue` 需验证幂等安全。
4. `discard` 需双人复核并写原因。

## 7. 复盘模板（强制）

1. 事故时间线。
2. 影响范围与用户影响。
3. 根因与触发条件。
4. 止损与恢复动作评估。
5. 遗留风险与改进项。
6. 新增回归用例清单。

## 8. 指标与告警对齐

1. 报告必须包含事故期间关键指标曲线。
2. 确认告警是否及时触发与升级。
3. 若告警缺失，作为整改 P0 项。

## 9. 验收标准

1. 事故处置流程可演练。
2. 复盘闭环（改进项责任人和截止时间）。
3. 同类事故再发率持续下降。

## 10. 关联文档

1. `docs/design/2026-02-21-error-handling-and-dlq-spec.md`
2. `docs/design/2026-02-21-agent-evals-observability.md`
3. `docs/ops/agent-change-management.md`
